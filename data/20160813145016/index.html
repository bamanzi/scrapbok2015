<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta name="viewport" content="width = device-width, initial-scale = 1, user-scalable = no">
		<title>Forwarding host port to service in container</title>
		<link type="text/css" rel="stylesheet" href="chrome://isreaditlater/content/text.css">
	</head>
	
	<body o="{&quot;L&quot;:0,&quot;S&quot;:1,&quot;F&quot;:1,&quot;M&quot;:1,&quot;A&quot;:1}" class=" L0 S1 F1 M1 A1" id="less">
	
		<div id="RIL_container"><!--!TOPOFCTN-->
		
	<div id="text_header">
		
			
	<div id="RIL_header">
		
		<div id="RIL_top">
			<!--RILTOP-->
			<cite><span><br><br>Original: </span><a href="https://copyninja.info/blog/port_forward_container.html" target="_blank">copyninja.info/blog/port_forward_container.html</a></cite>
			<a class="i" id="RIL_settings"></a>
		</div>
			
		<div id="RIL_settings_wrapper"></div>
		
		<br>
		
		<h1>Forwarding host port to service in container</h1>
		<span id="header_cite"><a href="http://copyninja.info/">copyninja.info</a><span class="RIL_date"><span class="RIL_date_sep"> | </span>Nov 9th 2015</span></span>
	</div>
	
	<div id="text_body">	
		<div lang="en">
<div class="row-fluid" nodeindex="23">
<div class="span8 offset2 article-content" nodeindex="24">
<div class="section" id="problem" nodeindex="25">
<h2 nodeindex="26">Problem</h2>
<p nodeindex="27">I've lxc container running distcc daemon and I would like to forward the distcc traffic coming to my host system to container.</p>
</div>
<div class="section" id="solution" nodeindex="28">
<h2 nodeindex="29">Solution</h2>
<p nodeindex="30">Following simple script which uses iptable did the job.</p>
<div class="highlight" nodeindex="31">
<pre nodeindex="32"> <span class="c" nodeindex="48">#!/bin/sh</span>
 <span class="nb" nodeindex="49">set</span> -e


usage<span class="o" nodeindex="50">()</span> <span class="o" nodeindex="51">{</span>
    cat <span class="s" nodeindex="52">&lt;&lt;EOF</span>
<span class="s" nodeindex="53">    $(basename $0) [options] &lt;in-interface&gt; &lt;out-interface&gt; &lt;port&gt; &lt;destination&gt;</span>

<span class="s" nodeindex="54">    --clear           Clear the previous rules before inserting new</span>
<span class="s" nodeindex="55">                      ones</span>

<span class="s" nodeindex="56">    --protocol        Protocol for the rules to use.</span>

<span class="s" nodeindex="57">    in-interface      Interface on which incoming traffic is expected</span>
<span class="s" nodeindex="58">    out-interface     Interface to which incoming traffic is to be</span>
<span class="s" nodeindex="59">                      forwarded.</span>

<span class="s" nodeindex="60">    port              Port to be forwarded. Can be integer or string</span>
<span class="s" nodeindex="61">                      from /etc/services.</span>
<span class="s" nodeindex="62">    destination       IP and port of the destination system to which</span>
<span class="s" nodeindex="63">                      traffic needs to be forwarded. This should be in</span>
<span class="s" nodeindex="64">                      form &lt;destination_ip:port&gt;</span>

<span class="s" nodeindex="65">(C) 2015 Vasudev Kamath - This program comes with ABSOLUTELY NO</span>
<span class="s" nodeindex="66">WARRANTY. This is free software, and you are welcome to redistribute</span>
<span class="s" nodeindex="67">it under the GNU GPL Version 3 (or later) License</span>

<span class="s" nodeindex="68">EOF</span>
<span class="o" nodeindex="69">}</span>

setup_portforwarding <span class="o" nodeindex="70">()</span> <span class="o" nodeindex="71">{</span>
    <span class="nb" nodeindex="72">local </span><span class="nv" nodeindex="73">protocol</span><span class="o" nodeindex="74">=</span><span class="s2" nodeindex="75">"</span><span class="nv" nodeindex="76">$1</span><span class="s2" nodeindex="77">"</span>
    iptables -t nat -A PREROUTING -i <span class="nv" nodeindex="78">$IN_INTERFACE</span> -p <span class="s2" nodeindex="79">"</span><span class="nv" nodeindex="80">$protocol</span><span class="s2" nodeindex="81">"</span> --dport <span class="nv" nodeindex="82">$PORT</span> <span class="se" nodeindex="83">\</span>
           -j DNAT --to <span class="nv" nodeindex="84">$DESTINATION</span>
    iptables -A FORWARD -p <span class="s2" nodeindex="85">"</span><span class="nv" nodeindex="86">$protocol</span><span class="s2" nodeindex="87">"</span> -d <span class="si" nodeindex="88">${</span><span class="nv" nodeindex="89">DESTINATION</span><span class="p" nodeindex="90">%%</span><span class="se" nodeindex="91">\:</span><span class="p" nodeindex="92">*</span><span class="si" nodeindex="93">}</span> --dport <span class="nv" nodeindex="94">$PORT</span> -j ACCEPT

    <span class="c" nodeindex="95"># Returning packet should have gateway IP</span>
    iptables -t nat -A POSTROUTING -s <span class="si" nodeindex="96">${</span><span class="nv" nodeindex="97">DESTINATION</span><span class="p" nodeindex="98">%%</span><span class="se" nodeindex="99">\:</span><span class="p" nodeindex="100">*</span><span class="si" nodeindex="101">}</span> -o <span class="se" nodeindex="102">\</span>
           <span class="nv" nodeindex="103">$IN_INTERFACE</span> -j SNAT --to <span class="si" nodeindex="104">${</span><span class="nv" nodeindex="105">IN_IP</span><span class="p" nodeindex="106">%%</span><span class="se" nodeindex="107">\/</span><span class="p" nodeindex="108">*</span><span class="si" nodeindex="109">}</span>

<span class="o" nodeindex="110">}</span>

<span class="k" nodeindex="111">if</span> <span class="o" nodeindex="112">[</span> <span class="k" nodeindex="113">$(</span>id -u<span class="k" nodeindex="114">)</span> -ne <span class="m" nodeindex="115">0</span> <span class="o" nodeindex="116">]</span><span class="p" nodeindex="117">;</span> <span class="k" nodeindex="118">then</span>
    <span class="nb" nodeindex="119">echo</span> <span class="s2" nodeindex="120">"You need to be root to run this script"</span>
    <span class="nb" nodeindex="121">exit </span>1
<span class="k" nodeindex="122">fi</span>

<span class="k" nodeindex="123">while</span> <span class="nb" nodeindex="124">true</span><span class="p" nodeindex="125">;</span> <span class="k" nodeindex="126">do</span>
    <span class="k" nodeindex="127">case</span> <span class="s2" nodeindex="128">"</span><span class="nv" nodeindex="129">$1</span><span class="s2" nodeindex="130">"</span> in
      --clear<span class="o" nodeindex="131">)</span>
          <span class="nv" nodeindex="132">CLEAR_RULES</span><span class="o" nodeindex="133">=</span>1
          <span class="nb" nodeindex="134">shift</span>
          <span class="p" nodeindex="135">;;</span>
      --protocol<span class="p" nodeindex="136">|</span>--protocol<span class="o" nodeindex="137">=</span>*?<span class="o" nodeindex="138">)</span>
      <span class="k" nodeindex="139">if</span> <span class="o" nodeindex="140">[</span> <span class="s2" nodeindex="141">"</span><span class="nv" nodeindex="142">$1</span><span class="s2" nodeindex="143">"</span> <span class="o" nodeindex="144">=</span> <span class="s2" nodeindex="145">"--protocol"</span> -a -n <span class="s2" nodeindex="146">"</span><span class="nv" nodeindex="147">$2</span><span class="s2" nodeindex="148">"</span> <span class="o" nodeindex="149">]</span><span class="p" nodeindex="150">;</span><span class="k" nodeindex="151">then</span>
          <span class="nv" nodeindex="152">PROTOCOL</span><span class="o" nodeindex="153">=</span><span class="s2" nodeindex="154">"</span><span class="nv" nodeindex="155">$2</span><span class="s2" nodeindex="156">"</span>
          <span class="nb" nodeindex="157">shift </span>2
      <span class="k" nodeindex="158">elif</span> <span class="o" nodeindex="159">[</span> <span class="s2" nodeindex="160">"</span><span class="si" nodeindex="161">${</span><span class="nv" nodeindex="162">1</span><span class="p" nodeindex="163">#--protocol=</span><span class="si" nodeindex="164">}</span><span class="s2" nodeindex="165">"</span> !<span class="o" nodeindex="166">=</span> <span class="s2" nodeindex="167">"</span><span class="nv" nodeindex="168">$1</span><span class="s2" nodeindex="169">"</span> <span class="o" nodeindex="170">]</span><span class="p" nodeindex="171">;</span> <span class="k" nodeindex="172">then</span>
          <span class="nv" nodeindex="173">PROTOCOL</span><span class="o" nodeindex="174">=</span><span class="s2" nodeindex="175">"</span><span class="si" nodeindex="176">${</span><span class="nv" nodeindex="177">1$-</span><span class="p" nodeindex="178">-protocol=</span><span class="si" nodeindex="179">}</span><span class="s2" nodeindex="180">"</span>
          <span class="nb" nodeindex="181">shift </span>1
      <span class="k" nodeindex="182">else</span>
          <span class="nb" nodeindex="183">echo</span> <span class="s2" nodeindex="184">"You need to specify protocl (tcp|udp)"</span>
          <span class="nb" nodeindex="185">exit </span>2
      <span class="k" nodeindex="186">fi</span>
      <span class="p" nodeindex="187">;;</span>

      *<span class="o" nodeindex="188">)</span>
          <span class="nb" nodeindex="189">break</span>
          <span class="p" nodeindex="190">;;</span>
    <span class="k" nodeindex="191">esac</span>
<span class="k" nodeindex="192">done</span>

<span class="k" nodeindex="193">if</span> <span class="o" nodeindex="194">[</span> <span class="nv" nodeindex="195">$# </span>-ne <span class="m" nodeindex="196">4</span> <span class="o" nodeindex="197">]</span><span class="p" nodeindex="198">;</span> <span class="k" nodeindex="199">then</span>
    usage <span class="nv" nodeindex="200">$0</span>
    <span class="nb" nodeindex="201">exit </span>2
<span class="k" nodeindex="202">fi</span>

<span class="nv" nodeindex="203">IN_INTERFACE</span><span class="o" nodeindex="204">=</span><span class="s2" nodeindex="205">"</span><span class="nv" nodeindex="206">$1</span><span class="s2" nodeindex="207">"</span>
<span class="nv" nodeindex="208">OUT_INTERFACE</span><span class="o" nodeindex="209">=</span><span class="s2" nodeindex="210">"</span><span class="nv" nodeindex="211">$2</span><span class="s2" nodeindex="212">"</span>
<span class="nv" nodeindex="213">PORT</span><span class="o" nodeindex="214">=</span><span class="s2" nodeindex="215">"</span><span class="nv" nodeindex="216">$3</span><span class="s2" nodeindex="217">"</span>
<span class="nv" nodeindex="218">DESTINATION</span><span class="o" nodeindex="219">=</span><span class="s2" nodeindex="220">"</span><span class="nv" nodeindex="221">$4</span><span class="s2" nodeindex="222">"</span>

<span class="c" nodeindex="223"># Get the incoming interface IP. This is used for SNAT.</span>
<span class="nv" nodeindex="224">IN_IP</span><span class="o" nodeindex="225">=</span><span class="k" nodeindex="226">$(</span>ip addr show <span class="nv" nodeindex="227">$IN_INTERFACE</span><span class="p" nodeindex="228">|</span><span class="se" nodeindex="229">\</span>
             perl -nE <span class="s1" nodeindex="230">'/inet\s(.*)\sbrd/ and print $1'</span><span class="k" nodeindex="231">)</span>


<span class="k" nodeindex="232">if</span> <span class="o" nodeindex="233">[</span> -n <span class="s2" nodeindex="234">"</span><span class="nv" nodeindex="235">$CLEAR_RULES</span><span class="s2" nodeindex="236">"</span> <span class="o" nodeindex="237">]</span><span class="p" nodeindex="238">;</span> <span class="k" nodeindex="239">then</span>
    iptables -t nat -X
    iptables -t nat -F
    iptables -F
<span class="k" nodeindex="240">fi</span>

<span class="k" nodeindex="241">if</span> <span class="o" nodeindex="242">[</span> -n <span class="s2" nodeindex="243">"</span><span class="nv" nodeindex="244">$PROTOCOL</span><span class="s2" nodeindex="245">"</span> <span class="o" nodeindex="246">]</span><span class="p" nodeindex="247">;</span> <span class="k" nodeindex="248">then</span>
    setup_portforwarding <span class="nv" nodeindex="249">$PROTOCOL</span>
<span class="k" nodeindex="250">else</span>
    setup_portforwarding tcp
    setup_portforwarding udp
<span class="k" nodeindex="251">fi</span>
</pre></div>
<p nodeindex="33">Coming to systemd-nspawn I see there is <em nodeindex="252">--port</em> option which takes argument in form <em nodeindex="253">proto:hostport:destport</em> where proto can be either <em nodeindex="254">tcp</em> or <em nodeindex="255">udp</em>, <em nodeindex="256">hostport</em> and <em nodeindex="257">destport</em> are number from 1-65535. This option assumes private networking enabled in the container. I've not tried this option yet but that simplifies quite a lot of thing, its like -p switch used by <em nodeindex="258">docker</em>.</p>
</div>
</div></div></div>
	<div class="clear"></div>
	</div>
	</div>
		</div>
	
	
	<!--!ENDOFPAGE-->
	
	
	
	</body>
</html>
