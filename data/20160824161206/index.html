<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta name="viewport" content="width = device-width, initial-scale = 1, user-scalable = no">
		<title>SSH Tips</title>
		<link type="text/css" rel="stylesheet" href="chrome://isreaditlater/content/text.css">
	</head>
	
	<body o="{&quot;L&quot;:0,&quot;S&quot;:1,&quot;F&quot;:1,&quot;M&quot;:1,&quot;A&quot;:1}" class=" L0 S1 F1 M1 A1" id="less">
	
		<div id="RIL_container"><!--!TOPOFCTN-->
		
	<div id="text_header">
		
			
	<div id="RIL_header">
		
		<div id="RIL_top">
			<!--RILTOP-->
			<cite><span><br><br>Original: </span><a href="http://lgfang.github.io/mynotes/utils/ssh.html" target="_blank">lgfang.github.io/mynotes/utils/ssh.html</a></cite>
			<a class="i" id="RIL_settings"></a>
		</div>
			
		<div id="RIL_settings_wrapper"></div>
		
		<br>
		
		<h1>SSH Tips</h1>
		<span id="header_cite">by <a class="RIL_author" href="http://www.gnu.org/software/emacs/">Emacs</a>, <a href="http://lgfang.github.io/">lgfang.github.io</a><span class="RIL_date"><br class="RIL_date_sep">November 5th 2015</span></span>
	</div>
	
	<div id="text_body">	
		<div id="RIL_ARTICLE_NOTE" class="note">
				<p>This page doesn't appear to be an article and therefore may not display well in the Article View. You may want to switch to the <a>Full Web Page view</a>.
				</p>
				<p>If you know there <em>should</em> be an <em>article</em> here, help improve the article parser by <a href="http://ideashower.com/support/read-it-later/report-pages-not-saving-well-offline-here/">reporting this page</a>. Thanks!
				</p></div><div lang="en">
<div class="container-narrow" nodeindex="1">
<div id="content" nodeindex="3">
<h1 class="title" nodeindex="4">SSH Tips</h1>
<div id="table-of-contents" nodeindex="5">
<h2 nodeindex="6">Table of Contents</h2>
<div id="text-table-of-contents" nodeindex="7">
</div>
</div>
<div id="outline-container-sec-1" class="outline-2" nodeindex="50">
<h2 id="sec-1" nodeindex="51">Client configuration</h2>
<div class="outline-text-2" id="text-1" nodeindex="52"></div>
<div id="outline-container-sec-1-1" class="outline-3" nodeindex="53">
<h3 id="sec-1-1" nodeindex="54">Files and file modes</h3>
<div class="outline-text-3" id="text-1-1" nodeindex="55">
<ul class="org-ul" nodeindex="57"><li nodeindex="56">Per-person directory <code nodeindex="347">~/.ssh</code></li>
<li nodeindex="58">Per-person configure file <code nodeindex="348">~/.ssh/config</code></li>
<li nodeindex="59">known hosts</li>
<li nodeindex="60">authorized keys</li>
<li nodeindex="61">private key</li>
<li nodeindex="62">File mode (permission):
<ul class="org-ul" nodeindex="64"><li nodeindex="63">The directory and file mode should be correct, which generally means no one else can either peek or fake your id.</li>
<li nodeindex="65">The file mode of home directory matters as well (? that seemed true once, but never reproduced).</li>
<li nodeindex="66"><b nodeindex="349">NOTE</b> If using a private key file <b nodeindex="350">owned by others</b> (by <code nodeindex="351">-o IdentityFile=/path/to/id_rsa</code>), its file mode doesnot matter.</li>
<li nodeindex="67">An example settings:
<pre class="example" nodeindex="68">$ ls -ld $HOME $HOME/.ssh $HOME/.ssh/*
drwx------ 23 lgfang typhoon  4096 Feb 18 11:54 /home/lgfang
drwx------  2 lgfang typhoon  4096 Feb 10 11:23 /home/lgfang/.ssh
-rw-r--r--  1 lgfang typhoon   402 Dec 14 09:49 /home/lgfang/.ssh/authorized_keys
-rw-r--r--  1 lgfang typhoon   531 Feb 10 11:23 /home/lgfang/.ssh/config
-rw-------  1 lgfang typhoon  1675 Dec  2 15:16 /home/lgfang/.ssh/id_rsa
-rw-r--r--  1 lgfang typhoon   418 Dec  2 15:16 /home/lgfang/.ssh/id_rsa.pub
-rw-r--r--  1 lgfang typhoon 12510 Feb 10 11:00 /home/lgfang/.ssh/known_hosts
</pre></li>
</ul></li>
</ul></div>
</div>
<div id="outline-container-sec-1-2" class="outline-3" nodeindex="69">
<h3 id="sec-1-2" nodeindex="70">An example of <code nodeindex="352">~/.ssh/config</code></h3>
<div class="outline-text-3" id="text-1-2" nodeindex="71">
<p nodeindex="72">Here is my configuration file. For detailed explanation, read the following sections.</p>
<div class="org-src-container" nodeindex="73">
<pre class="src src-conf-space" nodeindex="74"><span class="org-variable-name" nodeindex="353">Host</span> mydesktop
     <span class="org-variable-name" nodeindex="354">HostName</span> 192.168.1.101
     <span class="org-variable-name" nodeindex="355">User</span> lungangfang
     <span class="org-comment-delimiter" nodeindex="356"># </span><span class="org-comment" nodeindex="357">NOTE: do NOT set "ControlMaster Auto" as default for all</span>
     <span class="org-variable-name" nodeindex="358">ControlMaster</span> auto

<span class="org-variable-name" nodeindex="359">Host</span> vm*
     <span class="org-variable-name" nodeindex="360">User</span> root
     <span class="org-variable-name" nodeindex="361">IdentityFile</span> ~/.ssh/id_autoit
     <span class="org-variable-name" nodeindex="362">StrictHostKeyChecking</span> no
     <span class="org-variable-name" nodeindex="363">UserKnownHostsFile</span> /dev/null
     <span class="org-variable-name" nodeindex="364">LogLevel</span> ERROR

<span class="org-variable-name" nodeindex="365">Host</span> *
     <span class="org-variable-name" nodeindex="366">Protocol</span> 2,1
     <span class="org-variable-name" nodeindex="367">ServerAliveInterval</span> 180
     <span class="org-variable-name" nodeindex="368">ForwardX11</span> no
     <span class="org-variable-name" nodeindex="369">ControlPath</span> /tmp/%r_ssh_%h_%p
     <span class="org-variable-name" nodeindex="370">User</span> lgfang
     <span class="org-comment-delimiter" nodeindex="371"># </span><span class="org-comment" nodeindex="372">Compression yes</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-1-3" class="outline-3" nodeindex="75">
<h3 id="sec-1-3" nodeindex="76">It is a multi-match rather than a single-match.</h3>
<div class="outline-text-3" id="text-1-3" nodeindex="77">
<ul class="org-ul" nodeindex="79"><li nodeindex="78">Every entry matches takes effect.
<p nodeindex="80">For instance, configurations for "host 135.*" and that for "host 135.252.41.*" both apply to 135.252.41.248.</p>
</li>
<li nodeindex="81">The first matched options take effect.
<p nodeindex="82">If several entries all match and they all contain the option "user", then the value in the first matched entry is taken.</p>
<p nodeindex="83">NOTE: Hence, put general options at the of configure file.</p>
</li>
</ul></div>
</div>
<div id="outline-container-sec-1-4" class="outline-3" nodeindex="84">
<h3 id="sec-1-4" nodeindex="85">Host alias</h3>
<div class="outline-text-3" id="text-1-4" nodeindex="86">
<p nodeindex="87">Do not like entering long, hard-to-remember server IPs? Or, want to hide the IP from you scripts?</p>
<p nodeindex="88">You can set up host alias. Refer to my <code nodeindex="373">~/.ssh/config</code></p>
</div>
</div>
<div id="outline-container-sec-1-5" class="outline-3" nodeindex="89">
<h3 id="sec-1-5" nodeindex="90">Default user</h3>
<div class="outline-text-3" id="text-1-5" nodeindex="91">
<p nodeindex="92">Want to save the key-stikes for user name?</p>
<p nodeindex="93">Setup default user. Refer to my <code nodeindex="374">~/.ssh/config</code></p>
</div>
</div>
<div id="outline-container-sec-1-6" class="outline-3" nodeindex="94">
<h3 id="sec-1-6" nodeindex="95">ControlMaster</h3>
<div class="outline-text-3" id="text-1-6" nodeindex="96">
<p nodeindex="97">Enter password only once for multiple ssh sessions by "ControlMaster auto".</p>
<p nodeindex="98">For example, assume "Host 135.*" has option "ControlMaster auto". The first ssh session to 135.252.41.248 request password entered. After that, so long as the session alive, I can ssh that host without entering password again.</p>
<p nodeindex="99">NOTE</p>
<ol class="org-ol" nodeindex="101"><li nodeindex="100">"ControlPath" must set as well.</li>
<li nodeindex="102">Git, rysnc etc. would fail with 'ControlMaster auto'. Therefore, don not put "ControlMaster auto" under "Host *"</li>
</ol></div>
</div>
<div id="outline-container-sec-1-7" class="outline-3" nodeindex="103">
<h3 id="sec-1-7" nodeindex="104">Keep sessions alive</h3>
<div class="outline-text-3" id="text-1-7" nodeindex="105">
<p nodeindex="106">It turned out that almost all of us (my teammates and I) overlooked this feature while we were suffering from broken sessions :), even though it seems we all knew for sure that it must be certain firewall or alike that closes sessions being idle for an hour.</p>
<p nodeindex="107">The solution is actually just at hand: have ssh clients send keep-alive messages regularly, say, every 180 seconds.</p>
<ul class="org-ul" nodeindex="109"><li nodeindex="108">If you ssh to a server from certain linux box, edit your SSH config at your linux box (the ssh client side) as the following.
<div class="org-src-container" nodeindex="110">
<pre class="src src-conf-space" nodeindex="111"><span class="org-comment-delimiter" nodeindex="375"># </span><span class="org-comment" nodeindex="376">in either /etc/ssh/ssh_config or ~/.ssh/config</span>
<span class="org-variable-name" nodeindex="377">Host</span> *
     <span class="org-variable-name" nodeindex="378">ServerAliveInterval</span> 180
</pre></div>
<p nodeindex="112">Of course, specifying the option in command line (as in <code nodeindex="379">ssh -o ServerAliveInterval=180 remote_host</code>) also works.</p>
</li>
<li nodeindex="113">If you are a PuTTY user instead, in the "connection" panel, set seconds between keepalives to 180.</li>
</ul><p nodeindex="114"><b nodeindex="380">NOTE:</b> quote from <a href="http://the.earth.li/~sgtatham/putty/0.63/htmldoc/Chapter4.html#config-keepalive" nodeindex="381">here</a></p>
<blockquote nodeindex="115">
<p nodeindex="116">Note that keepalives are not always helpful. They help if you have a firewall which drops your connection after an idle period; but if the network between you and the server suffers from breaks in connectivity then keepalives can actually make things worse. If a session is idle, and connectivity is temporarily lost between the endpoints, but the connectivity is restored before either side tries to send anything, then there will be no problem - neither endpoint will notice that anything was wrong. However, if one side does send something during the break, it will repeatedly try to re-send, and eventually give up and abandon the connection. Then when connectivity is restored, the other side will find that the first side doesn't believe there is an open connection any more. Keepalives can make this sort of problem worse, because they increase the probability that PuTTY will attempt to send data during a break in connectivity. (Other types of periodic network activity can cause this behaviour; in particular, SSH-2 re-keys can have this effect. See section 4.19.2.)</p>
</blockquote>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2" nodeindex="117">
<h2 id="sec-2" nodeindex="118">Host key conflict</h2>
<div class="outline-text-2" id="text-2" nodeindex="119"></div>
<div id="outline-container-sec-2-0-1" class="outline-4" nodeindex="120">
<h4 id="sec-2-0-1" nodeindex="382">What is this</h4>
<div class="outline-text-4" id="text-2-0-1" nodeindex="121">
<p nodeindex="122">The remote host (ssh server) sends a host key (The default is <code nodeindex="383">/etc/ssh/ssh_host_key.pub</code> for protocol version 1, and <code nodeindex="384">/etc/ssh/ssh_host_rsa_key.pub</code> or <code nodeindex="385">/etc/ssh/ssh_host_dsa_key.pub</code> for protocol version 2.).</p>
<p nodeindex="123">The ssh client will compare that with the one stored in <code nodeindex="386">~/.ssh/known_hosts</code>. If they do not match, you'll get an error like the following.</p>
<pre class="example" nodeindex="124">$ ssh 135.1.2.3
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!
Someone could be eavesdropping on you right now (man-in-the-middle attack)!
...
<span id="coderef-info" class="coderef-off" nodeindex="387">Offending key in /home/lungangfang/.ssh/known_hosts:191</span>
RSA host key for 135.1.2.3 has changed and you have requested strict checking.
Host key verification failed.
</pre></div>
</div>
<div id="outline-container-sec-2-0-2" class="outline-4" nodeindex="125">
<h4 id="sec-2-0-2" nodeindex="388">Solution 1: delete the stored key</h4>
<div class="outline-text-4" id="text-2-0-2" nodeindex="126">
<p nodeindex="127">Just delete corresponding entry (as shown in <a href="http://lgfang.github.io/mynotes/utils/ssh.html#coderef-info" class="coderef" nodeindex="389">this line</a>) in <code nodeindex="390">known_hosts</code>. This is actually a one-liner:</p>
<div class="org-src-container" nodeindex="128">
<pre class="src src-shell-script" nodeindex="129">sed -i 191d /home/lungangfang/.ssh/known_hosts
</pre></div>
</div>
</div>
<div id="outline-container-sec-2-0-3" class="outline-4" nodeindex="130">
<h4 id="sec-2-0-3" nodeindex="391">Solution 2: ignore the conflict</h4>
<div class="outline-text-4" id="text-2-0-3" nodeindex="131">
<div class="org-src-container" nodeindex="132">
<pre class="src src-shell-script" nodeindex="133">ssh -o <span class="org-variable-name" nodeindex="392">StrictHostKeyChecking</span>=no -o <span class="org-variable-name" nodeindex="393">UserKnownHostsFile</span>=/dev/null 135.1.2.3
</pre></div>
<p nodeindex="134">Where:</p>
<dl class="org-dl" nodeindex="394"><dt nodeindex="395">StrictHostKeyChecking no</dt>
<dd nodeindex="396">tells ssh client to connect regardless of host keys check result.</dd>
<dt nodeindex="397">UserKnownHostsFile /dev/null</dt>
<dd nodeindex="398">makes ssh client store host keys to nowhere (/dev/null).</dd>
</dl><p nodeindex="135">Since we do not care host keys of labs at all, you may want to put above options into corresponding section of <code nodeindex="399">~/.ssh/config</code>.</p>
</div>
</div>
<div id="outline-container-sec-2-0-4" class="outline-4" nodeindex="136">
<h4 id="sec-2-0-4" nodeindex="400">Manipulating keys and fingerprints</h4>
<div class="outline-text-4" id="text-2-0-4" nodeindex="137">
<div class="org-src-container" nodeindex="138">
<pre class="src src-shell-script" nodeindex="139"><span class="org-comment-delimiter" nodeindex="401"># </span><span class="org-comment" nodeindex="402">Retrieve remote host key of HOST without login it</span>
ssh-keyscan -t rsa,dsa HOST

<span class="org-comment-delimiter" nodeindex="403"># </span><span class="org-comment" nodeindex="404">List fingerprints of every public key in a file</span>
ssh-keygen -lf ~/.ssh/known_hosts
ssh-keygen -lf /dev/stdin &lt;&lt;&lt; $(<span class="org-sh-quoted-exec" nodeindex="405">ssh-keyscan</span> HOST)
<span class="org-keyword" nodeindex="406">for</span> each<span class="org-keyword" nodeindex="407"> in</span> /etc/ssh/ssh_host_*key.pub; <span class="org-keyword" nodeindex="408">do</span> ssh-keygen -lf $<span class="org-variable-name" nodeindex="409">each</span>; <span class="org-keyword" nodeindex="410">done</span>

<span class="org-comment-delimiter" nodeindex="411"># </span><span class="org-comment" nodeindex="412">Delete a public key from a file (default ~/.ssh/known_hosts)</span>
ssh-keygen -R HOST
</pre></div>
</div>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2" nodeindex="140">
<h2 id="sec-3" nodeindex="141">Public-key authentication</h2>
<div class="outline-text-2" id="text-3" nodeindex="142">
<p nodeindex="143">Login without entering password.</p>
</div>
<div id="outline-container-sec-3-1" class="outline-3" nodeindex="144">
<h3 id="sec-3-1" nodeindex="145">Set up</h3>
<div class="outline-text-3" id="text-3-1" nodeindex="146">
<ol class="org-ol" nodeindex="148"><li nodeindex="147">Server side should have already enabled PubkeyAuthentication.
<p nodeindex="149">That is usually the case. Otherwise, you'll have to do it youself as "root"</p>
<ol class="org-ol" nodeindex="151"><li nodeindex="150">edit <code nodeindex="413">/etc/ssh/sshd_conf</code>
<div class="org-src-container" nodeindex="152">
<pre class="src src-conf-space" nodeindex="153"><span class="org-variable-name" nodeindex="414">RSAAuthentication</span> yes
<span class="org-variable-name" nodeindex="415">PubkeyAuthentication</span> yes
</pre></div>
</li>
<li nodeindex="154">restart <code nodeindex="416">/etc/init.d/sshd restart</code></li>
</ol></li>
<li nodeindex="155">Check permissions of configuration directory and files on client side (refer to <i nodeindex="417">*Files</i>).</li>
<li nodeindex="156">Generate public/private keys
<p nodeindex="157">For putty, refer to <a href="http://lgfang.github.io/mynotes/utils/putty.html" nodeindex="418">./putty.html</a></p>
<p nodeindex="158">To set/clear/change passphrase of private keys</p>
<div class="org-src-container" nodeindex="159">
<pre class="src src-shell-script" nodeindex="160">ssh-keygen -p
</pre></div>
</li>
</ol></div>
</div>
<div id="outline-container-sec-3-2" class="outline-3" nodeindex="161">
<h3 id="sec-3-2" nodeindex="162">Choosing type of keys</h3>
<div class="outline-text-3" id="text-3-2" nodeindex="163">
<p nodeindex="164">Usually, the type of keys just does not matter. The default type is RSA. And, some believe it is better than DSA. For more detailed comparison and analysis, please turn to google.</p>
</div>
</div>
<div id="outline-container-sec-3-3" class="outline-3" nodeindex="165">
<h3 id="sec-3-3" nodeindex="166">SSH agent</h3>
<div class="outline-text-3" id="text-3-3" nodeindex="167">
<p nodeindex="168">It is kind of a dilemma when using pub-key auth that: if we set passphrase for a private key file we will have to re-enter it every time we use that private key; on the other hand, if we do not set passphrase everyone has access to the private key file, say a nasty administrator, can use it.</p>
<p nodeindex="169">Here is when ssh-agent steps in. Note that ssh-agent bring in a security whole as well. For example, when the ssh-agent is running, root may "su" as you and take advantage of that agent.</p>
<p nodeindex="170">Hence, based on how paranoid you are, you may choose to:</p>
<ol class="org-ol" nodeindex="172"><li nodeindex="171">Do not use ssh-agent at all.</li>
<li nodeindex="173">Use ssh-agent occasionally and kill it right away.</li>
<li nodeindex="174">Make ssh-agent a daemon (always running)</li>
</ol><p nodeindex="175">Here are the commands involved:</p>
<div class="org-src-container" nodeindex="176">
<pre class="src src-shell-script" nodeindex="177"><span class="org-comment-delimiter" nodeindex="419"># </span><span class="org-comment" nodeindex="420">start ssh-keygen, set corresponding env</span>
<span class="org-builtin" nodeindex="421">eval</span> $(<span class="org-sh-quoted-exec" nodeindex="422">ssh-agent</span> -s)            <span class="org-comment-delimiter" nodeindex="423"># </span><span class="org-comment" nodeindex="424">for csh, eval `ssh-agent -c`</span>

<span class="org-comment-delimiter" nodeindex="425"># </span><span class="org-comment" nodeindex="426">add private keys, will prompted for the passphrase for each key file</span>
ssh-add

<span class="org-comment-delimiter" nodeindex="427"># </span><span class="org-comment" nodeindex="428">ssh as usual, but without entering passphrase</span>

<span class="org-comment-delimiter" nodeindex="429"># </span><span class="org-comment" nodeindex="430">stop ssh-agent</span>
ssh-agent -k
</pre></div>
<p nodeindex="178">And a light-weight wrapper</p>
<div class="org-src-container" nodeindex="179">
<pre class="src src-shell-script" nodeindex="180"><span class="org-comment-delimiter" nodeindex="431"># </span><span class="org-comment" nodeindex="432">get a command-line ready for being copied/pasted to other terminals to access</span>
<span class="org-comment-delimiter" nodeindex="433"># </span><span class="org-comment" nodeindex="434">the ssh-agent</span>
<span class="org-keyword" nodeindex="435">function</span> <span class="org-function-name" nodeindex="436">get_ssh_agent</span> {

    <span class="org-keyword" nodeindex="437">if</span> [ -z <span class="org-string" nodeindex="438">"$SSH_AGENT_PID"</span> -o -z <span class="org-string" nodeindex="439">"$SSH_AUTH_SOCK"</span> ]; <span class="org-keyword" nodeindex="440">then</span>
        <span class="org-comment-delimiter" nodeindex="441"># </span><span class="org-comment" nodeindex="442">cmd=$(</span><span class="org-sh-quoted-exec" nodeindex="443">ssh-agent</span><span class="org-comment" nodeindex="444"> -s)</span>
        <span class="org-comment-delimiter" nodeindex="445"># </span><span class="org-comment" nodeindex="446">eval $cmd</span>
        <span class="org-comment-delimiter" nodeindex="447"># </span><span class="org-comment" nodeindex="448">echo $cmd</span>
        <span class="org-builtin" nodeindex="449">echo</span> <span class="org-string" nodeindex="450">"No ssh agent in this terminal"</span>
    <span class="org-keyword" nodeindex="451">else</span>
        <span class="org-keyword" nodeindex="452">for</span> each<span class="org-keyword" nodeindex="453"> in</span> SSH_AGENT_PID SSH_AUTH_SOCK; <span class="org-keyword" nodeindex="454">do</span>
            <span class="org-builtin" nodeindex="455">eval</span> <span class="org-string" nodeindex="456">"echo export $each=\${$each}"</span>
        <span class="org-keyword" nodeindex="457">done</span>
    <span class="org-keyword" nodeindex="458">fi</span>
}
</pre></div>
</div>
</div>
<div id="outline-container-sec-3-4" class="outline-3" nodeindex="181">
<h3 id="sec-3-4" nodeindex="182">Get public key from prviate key</h3>
<div class="outline-text-3" id="text-3-4" nodeindex="183">
<p nodeindex="184">This is useful to test if a pair of keys matches.</p>
<pre class="example" nodeindex="185">ssh-keygen -y [-f input_keyfile]
</pre></div>
</div>
<div id="outline-container-sec-3-5" class="outline-3" nodeindex="186">
<h3 id="sec-3-5" nodeindex="187">Force Password Authentication</h3>
<div class="outline-text-3" id="text-3-5" nodeindex="188">
<p nodeindex="189">Sometimes, for debugging, we do want password authentication for a short period. This can be done without modifying configuration files.</p>
<pre class="example" nodeindex="190">ssh -o PreferredAuthentications=password user@server
</pre>
<p nodeindex="191">For SSH1 connections, try <code nodeindex="459">-o RSAAuthentication=no</code>.</p>
</div>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2" nodeindex="192">
<h2 id="sec-4" nodeindex="193">SSH scripting</h2>
<div class="outline-text-2" id="text-4" nodeindex="194"></div>
<div id="outline-container-sec-4-1" class="outline-3" nodeindex="195">
<h3 id="sec-4-1" nodeindex="196">Options for ssh within a script</h3>
<div class="outline-text-3" id="text-4-1" nodeindex="197">
<pre class="example" nodeindex="198">-tt
-o BatchMode=yes
-o ConnectTimeout=2
-o ConnectionAttempts=2
-o LogLevel=error
</pre></div>
</div>
<div id="outline-container-sec-4-2" class="outline-3" nodeindex="199">
<h3 id="sec-4-2" nodeindex="200">Redirect IO between local and remote machines</h3>
<div class="outline-text-3" id="text-4-2" nodeindex="201"></div>
<div id="outline-container-sec-4-2-1" class="outline-4" nodeindex="202">
<h4 id="sec-4-2-1" nodeindex="460">Use case 1</h4>
<div class="outline-text-4" id="text-4-2-1" nodeindex="203">
<div class="org-src-container" nodeindex="204">
<pre class="src src-shell-script" nodeindex="205"><span class="org-comment-delimiter" nodeindex="461"># </span><span class="org-comment" nodeindex="462">Package on remote server and save to local host, need no temporary files</span>
ssh lgfang@135.1.2.3 <span class="org-string" nodeindex="463">"tar cvfz - vlcs"</span> &gt; vlcs.tar.gz

<span class="org-comment-delimiter" nodeindex="464"># </span><span class="org-comment" nodeindex="465">Upload a number of files in one command, need no temporary files</span>
tar hcvfz -                     <span class="org-sh-escaped-newline" nodeindex="466">\</span>
    .hosts                      <span class="org-sh-escaped-newline" nodeindex="467">\</span>
    .tmux.conf                  <span class="org-sh-escaped-newline" nodeindex="468">\</span>
    .emacs.d/init.el            <span class="org-sh-escaped-newline" nodeindex="469">\</span>
    | ssh lgfang@135.1.2.3 <span class="org-string" nodeindex="470">"tar xvfz -"</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-4-2-2" class="outline-4" nodeindex="206">
<h4 id="sec-4-2-2" nodeindex="471">Use case 2</h4>
<div class="outline-text-4" id="text-4-2-2" nodeindex="207">
<p nodeindex="208">The "/backup" directory locates on blade 0-0-2, which is only accessible from the "pilot" blade. To download the "docs",</p>
<div class="org-src-container" nodeindex="209">
<pre class="src src-shell-script" nodeindex="210">ssh root@pilot_pub_ip <span class="org-string" nodeindex="472">'ssh 0-0-2 "tar cvfz - /backup"'</span> <span class="org-sh-escaped-newline" nodeindex="473">\</span>
    | tar xvfz -
</pre></div>
</div>
</div>
<div id="outline-container-sec-4-2-3" class="outline-4" nodeindex="211">
<h4 id="sec-4-2-3" nodeindex="474">Use case 3</h4>
<div class="outline-text-4" id="text-4-2-3" nodeindex="212">
<p nodeindex="213">"Deploy" new binary to a virutal blade in openstack.</p>
<div class="org-src-container" nodeindex="214">
<pre class="src src-shell-script" nodeindex="215">cat a.jar | ssh me@host <span class="org-string" nodeindex="475">'ssh root@pilot "cat - &gt;a.jar &amp;&amp; scp ./a.jar 0-0-2:./"'</span>
</pre></div>
</div>
</div>
</div>
<div id="outline-container-sec-4-3" class="outline-3" nodeindex="216">
<h3 id="sec-4-3" nodeindex="217">Force pseudo-tty allocation</h3>
<div class="outline-text-3" id="text-4-3" nodeindex="218">
<ul class="org-ul" nodeindex="220"><li nodeindex="219">"-t" Force pseudo-tty allocation. This can be used to execute arbitrary screen-based programs on a remote machine. To name a few:
<ul class="org-ul" nodeindex="222"><li nodeindex="221">Run tmux directly
<pre class="example" nodeindex="223">ssh -t lungangfang@qdbuild2 tmux attach
</pre></li>
<li nodeindex="224">SSH via a machine in the middle
<pre class="example" nodeindex="225">ssh -t host_middle ssh dest_host
</pre></li>
<li nodeindex="226">Sudo shutdown
<pre class="example" nodeindex="227">$ ssh lgfang@135.1.2.3 sudo shutdown now
lgfang@135.1.2.3's password:
stty: standard input: Inappropriate ioctl for device
sudo: sorry, you must have a tty to run sudo

$ ssh -t lgfang@135.1.2.3 sudo shutdown now
lgfang@135.1.2.3's password:

Broadcast message from ...

The system is going down for power-off NOW!

Connection to 135.1.2.3 closed.
</pre></li>
</ul></li>
<li nodeindex="228">"-tt" (Multiple -t options) force tty allocation, even if ssh has no local tty. i.e. force tty allocation when calling ssh in a script.</li>
</ul></div>
</div>
<div id="outline-container-sec-4-4" class="outline-3" nodeindex="229">
<h3 id="sec-4-4" nodeindex="230">SSH processes eat stdin</h3>
<div class="outline-text-3" id="text-4-4" nodeindex="231">
<p nodeindex="232">That is why SSH in a "while read xxx" loop makes the loop run only once. The SSH drains the stdin!</p>
<pre class="example" nodeindex="233">$ seq 1 3 | while read id;do ssh user@10.102.1.98 "echo hi"; done
hi
</pre>
<p nodeindex="234">Note that while block looped only once.</p>
<p nodeindex="235">There are a couple of solutions:</p>
<ol class="org-ol" nodeindex="237"><li nodeindex="236">Redirect ssh within the loop
<pre class="example" nodeindex="238">$ seq 1 3 | while read line;do ssh user@10.102.1.98 "echo hi" &lt;/dev/null; done
hi
hi
hi
</pre></li>
<li nodeindex="239">Use <code nodeindex="476">-n</code> option of ssh
<pre class="example" nodeindex="240">$ seq 1 3 | while read line;do ssh -n user@10.102.1.98 "echo hi"; done
hi
hi
hi
</pre></li>
<li nodeindex="241">Read from another file descriptor
<pre class="example" nodeindex="242">$ seq 1 3 &gt; list.txt

$ while read -u 99 line;do ssh user@10.102.1.98 "echo hi"; done 99&lt;list.txt
hi
hi
hi
</pre></li>
</ol></div>
</div>
<div id="outline-container-sec-4-5" class="outline-3" nodeindex="243">
<h3 id="sec-4-5" nodeindex="244">Run command on a remote server on background</h3>
<div class="outline-text-3" id="text-4-5" nodeindex="245">
<p nodeindex="246">Use <code nodeindex="477">-f</code>. Note however, this time you needn't (and should not) append "&amp;" to the end of your command.</p>
<div class="org-src-container" nodeindex="247">
<pre class="src src-shell-script" nodeindex="248">ssh -f -ttq $<span class="org-variable-name" nodeindex="478">OTHER_SSH_OPTIONS</span> <span class="org-string" nodeindex="479">"mycmd"</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-4-6" class="outline-3" nodeindex="249">
<h3 id="sec-4-6" nodeindex="250">Set up PS1 "before" login</h3>
<div class="outline-text-3" id="text-4-6" nodeindex="251">
<div class="org-src-container" nodeindex="252">
<pre class="src src-tcl" nodeindex="253">spawn ssh -q -o StrictHostKeyChecking=no <span class="org-tcl-escaped-newline" nodeindex="480">\</span>
    -o UserKnownHostsFile=/dev/null $<span class="org-variable-name" nodeindex="481">username</span>@$<span class="org-variable-name" nodeindex="482">vm</span> <span class="org-tcl-escaped-newline" nodeindex="483">\</span>
    -t <span class="org-string" nodeindex="484">"PS1='AUTOIT ' bash -i"</span>
</pre></div>
</div>
</div>
<div id="outline-container-sec-4-7" class="outline-3" nodeindex="254">
<h3 id="sec-4-7" nodeindex="255">SSH remote commands get fewer environment variables</h3>
<div class="outline-text-3" id="text-4-7" nodeindex="256">
<p nodeindex="257">Please do bear in mind that personal settings (<code nodeindex="485">$HOME/.profile</code> etc.) are not executed when you run <code nodeindex="486">ssh user@remote cmd</code> (because it is run in a non-interactive, non-login shell).</p>
<p nodeindex="258">Some of the consequences are:</p>
<ol class="org-ol" nodeindex="260"><li nodeindex="259">Your customization of environment variables does not take effect at all.</li>
<li nodeindex="261">Some commands fail only when being evoked as ssh remote commands</li>
<li nodeindex="262">Some commands behave "strangely" if evoked as ssh remote commands.</li>
</ol><p nodeindex="263">NOTE: Sometimes, it is really hard to link the unexpected output to the missing of environment variables.</p>
<p nodeindex="264">Solutions:</p>
<ul class="org-ul" nodeindex="266"><li nodeindex="265">On server side:
<ol class="org-ol" nodeindex="268"><li nodeindex="267">Make <code nodeindex="487">PermitUserEnvironment=yes</code> in <code nodeindex="488">sshd_config</code> (and restart sshd)</li>
<li nodeindex="269">Set up environment in <code nodeindex="489">$HOME/.ssh/environment</code>.</li>
</ol></li>
<li nodeindex="270">Or, "manually" set up env in command line:
<pre class="example" nodeindex="271">ssh -t lungangfang@135.252.41.248 'PATH=/my/path:$PATH; echo $PATH'
</pre></li>
<li nodeindex="272">Or, on server side, set up environment in <code nodeindex="490">/etc/profile</code> which always gets executed (NOTE: this is not true for KSH).</li>
</ul></div>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2" nodeindex="273">
<h2 id="sec-5" nodeindex="274">X11 Forwarding</h2>
<div class="outline-text-2" id="text-5" nodeindex="275">
<p nodeindex="276">It is way more convenient than "export DISPLAY".</p>
<ol class="org-ol" nodeindex="278"><li nodeindex="277">Make sure X forwarding allowed by server side ("sshd").</li>
<li nodeindex="279">Connect with "ForwardX11" enabled
<ul class="org-ul" nodeindex="281"><li nodeindex="280">"ssh -X xxx", or</li>
<li nodeindex="282">In configure file, "ForwardX11 yes"</li>
</ul><p nodeindex="283">If got error like "error in locking authority file", simply delete that file on server (so that it is regenerated). Or, <code nodeindex="491">chmod 0600</code> it.</p>
</li>
<li nodeindex="284">Run "xeyes" or whatever X application to test.</li>
</ol><p nodeindex="285">Seems needn't worry about <code nodeindex="492">xhost +</code> and <code nodeindex="493">-nolisten tcp</code> etc.</p>
</div>
</div>
<div id="outline-container-sec-6" class="outline-2" nodeindex="286">
<h2 id="sec-6" nodeindex="287">Multi-hop</h2>
<div class="outline-text-2" id="text-6" nodeindex="288">
<ul class="org-ul" nodeindex="290"><li nodeindex="289">Nested ssh connections
<div class="org-src-container" nodeindex="291">
<pre class="src src-shell-script" nodeindex="292">ssh -t 135.1.136.193 ssh 10.102.1.118
</pre></div>
<ol class="org-ol" nodeindex="294"><li nodeindex="293">Simple.</li>
<li nodeindex="295">ssh config on the intermidiate host takes effect.</li>
</ol></li>
<li nodeindex="296">Tunneling
<p nodeindex="297">The tunnel can be set either locally (for you only) or on the intermidiate server (for everyone)</p>
<div class="org-src-container" nodeindex="298">
<pre class="src src-shell-script" nodeindex="299"><span class="org-comment-delimiter" nodeindex="494"># </span><span class="org-comment" nodeindex="495">1. set a local tunnel</span>
ssh -L 8000:target_host:22 intermidiate_user@intermidiate_host
<span class="org-comment-delimiter" nodeindex="496"># </span><span class="org-comment" nodeindex="497">2. connect to 10.102.1.118 via the tunnel</span>
ssh -p 8000 target_user@localhost
scp -P 8000 ./test.file target_user@localhost:./
</pre></div>
<ol class="org-ol" nodeindex="301"><li nodeindex="300">You have to set up the tunnel beforehand and keep it open.</li>
<li nodeindex="302">scp directly from/to the target host works.</li>
</ol></li>
<li nodeindex="303">iptables DNAT
<p nodeindex="304">You need root privilege to setup iptables rules.</p>
</li>
</ul></div>
</div>
<div id="outline-container-sec-7" class="outline-2" nodeindex="305">
<h2 id="sec-7" nodeindex="306">Forced command</h2>
<div class="outline-text-2" id="text-7" nodeindex="307">
<p nodeindex="308">This can be done by putting commands into authorized_keys (refer to <a href="http://oreilly.com/catalog/sshtdg/chapter/ch08.html" nodeindex="498">http://oreilly.com/catalog/sshtdg/chapter/ch08.html</a>). For instance:</p>
<pre class="example" nodeindex="309">command="LANG=en_US.UTF-8 tmux -2 attach || tmux -2 new -s foo" ..key..
</pre>
<p nodeindex="310">Or, configure it in sshd_config as shown in <a href="http://lgfang.github.io/mynotes/utils/ssh.html#sec-8" nodeindex="499">sftp jail</a>.</p>
</div>
</div>
<div id="outline-container-sec-8" class="outline-2" nodeindex="311">
<h2 id="sec-8" nodeindex="312">sftp jail</h2>
<div class="outline-text-2" id="text-8" nodeindex="313">
<p nodeindex="314">This procedure tested on CentOS6.5.</p>
<ol class="org-ol" nodeindex="316"><li nodeindex="315">Configure and sshd
<ul class="org-ul" nodeindex="318"><li nodeindex="317">Change subsystem sftp to internal-sftp</li>
<li nodeindex="319">For users in certain group
<ul class="org-ul" nodeindex="321"><li nodeindex="320">force command to internal sftp</li>
<li nodeindex="322">chroot to their home</li>
</ul></li>
</ul><p nodeindex="323">Edit <code nodeindex="500">/etc/ssh/sshd_config</code></p>
<div class="org-src-container" nodeindex="324">
<pre class="src src-conf-space" nodeindex="325"><span class="org-variable-name" nodeindex="501">Subsystem</span>     sftp     internal-sftp
<span class="org-comment-delimiter" nodeindex="502"># </span><span class="org-comment" nodeindex="503">NOTE: must put this section to the end of sshd_config. Refer to</span>
<span class="org-comment-delimiter" nodeindex="504"># </span><span class="org-comment" nodeindex="505">description of "Match" in (man "sshd_config") for more.</span>
<span class="org-variable-name" nodeindex="506">Match</span> Group sftponly
<span class="org-variable-name" nodeindex="507">ChrootDirectory</span> %h
<span class="org-variable-name" nodeindex="508">ForceCommand</span> internal-sftp
<span class="org-variable-name" nodeindex="509">AllowTcpForwarding</span> no
</pre></div>
<div class="org-src-container" nodeindex="326">
<pre class="src src-shell-script" nodeindex="327">sudo service restart sshd
</pre></div>
</li>
<li nodeindex="328">Create(setup) accounts
<div class="org-src-container" nodeindex="329">
<pre class="src src-shell-script" nodeindex="330">sudo groupadd sftponly
sudo useradd -g sftponly lgfang
sudo usermod -s /dev/null lgfang
<span class="org-comment-delimiter" nodeindex="510"># </span><span class="org-comment" nodeindex="511">important ! file owner and permision must be correct</span>
sudo chown root:root /home/lgfang
sudo chmod 755 /home/lgfang
</pre></div>
</li>
<li nodeindex="331">Done. Reference: <a href="http://derek.rule88.com/2011/05/17/simple-jailed-sftp-users-with-centos/" nodeindex="512">here</a> and <a href="https://bensmann.no/restrict-sftp-users-to-home-folder/" nodeindex="513">here</a>.</li>
</ol></div>
</div>
<div id="outline-container-sec-9" class="outline-2" nodeindex="332">
<h2 id="sec-9" nodeindex="333">Limit bandwidth</h2>
<div class="outline-text-2" id="text-9" nodeindex="334">
<pre class="example" nodeindex="335">scp -l limit you@host:/home/you/* .
</pre>
<p nodeindex="336">where <i nodeindex="514">limit</i> is in Kb</p>
</div>
</div>
<div id="outline-container-sec-10" class="outline-2" nodeindex="337">


</div>
</div>
<div id="postamble" class="status" nodeindex="344"><br nodeindex="516">
<div id="disqus_thread" nodeindex="346"></div>
   </div>
</div>

</div>
	<div class="clear"></div>
	</div>
	</div>
		</div>
	
	
	<!--!ENDOFPAGE-->
	
	
	
	</body>
</html>
